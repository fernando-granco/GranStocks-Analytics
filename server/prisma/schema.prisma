generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  fullName           String?
  passwordHash       String
  role               String    @default("USER") // ENUM(USER, ADMIN)
  emailVerifiedAt    DateTime?
  lastLoginAt        DateTime?
  status             String    @default("ACTIVE") // ENUM(ACTIVE, BANNED)
  mustChangePassword Boolean   @default(false)
  timezone           String    @default("America/Toronto")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  trackedAssets  TrackedAsset[]
  llmConfigs     UserLLMConfig[]
  narratives     AiNarrative[]
  preferences    UserPreferences?
  universes      Universe[]
  resetTokens    PasswordResetToken[]
  adminAudits    AdminAuditLog[]      @relation("actor")
  targetAudits   AdminAuditLog[]      @relation("target")
  AnalysisConfig AnalysisConfig[]
  PromptTemplate PromptTemplate[]
  AlertGroup        AlertRule[]
  PortfolioGroup    PortfolioPosition[]
  InviteCodeUse     InviteCodeUse[]
}

model Asset {
  symbol      String  @id
  type        String  @default("STOCK") // Enum(STOCK) represented as string in SQLite
  displayName String
  exchange    String?
  currency    String  @default("USD")
  isActive    Boolean @default(true)
}

model TrackedAsset {
  id        String   @id @default(uuid())
  userId    String
  symbol    String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, symbol])
}

model CachedResponse {
  cacheKey    String   @id
  payloadJson String
  ts          DateTime @default(now())
  ttlSeconds  Int
  isStale     Boolean  @default(false)
  source      String // ENUM(FINNHUB)
}

model IndicatorSnapshot {
  id             String   @id @default(uuid())
  symbol         String
  date           String // YYYY-MM-DD
  indicatorsJson String
  createdAt      DateTime @default(now())

  @@unique([symbol, date])
}

model PredictionSnapshot {
  id                 String   @id @default(uuid())
  symbol             String
  date               String // YYYY-MM-DD
  horizonDays        Int // 1, 5, 20
  predictedReturnPct Float
  predictedPrice     Float
  confidence         Float // 0-1
  featuresJson       String
  explanationText    String
  createdAt          DateTime @default(now())

  @@unique([symbol, date, horizonDays])
}

model UserLLMConfig {
  id              String   @id @default(uuid())
  userId          String
  name            String // e.g. "ChatGPT"
  provider        String // OPENAI, GOOGLE, ANTHROPIC, XAI, OPENROUTER, DEEPSEEK, PERPLEXITY, OPENAI_COMPAT
  model           String
  encryptedApiKey String
  keyLast4        String
  baseUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user       User          @relation(fields: [userId], references: [id])
  narratives AiNarrative[]
}

model AiNarrative {
  id           String   @id @default(uuid())
  userId       String
  assetType    String   @default("STOCK") // STOCK or CRYPTO
  symbol       String? // null = daily summary
  date         String // YYYY-MM-DD
  role         String   @default("CONSENSUS")
  llmConfigId  String
  contentText  String
  providerUsed String
  modelUsed    String
  createdAt    DateTime @default(now())

  user      User          @relation(fields: [userId], references: [id])
  llmConfig UserLLMConfig @relation(fields: [llmConfigId], references: [id])
}

model ScreenerSnapshot {
  id            String   @id @default(uuid())
  date          String // YYYY-MM-DD
  universeType  String // STOCK | CRYPTO
  universeName  String
  symbol        String
  assetType     String   @default("STOCK")
  score         Float
  metricsJson   String
  riskFlagsJson String   @default("{}")
  price         Float    @default(0)
  source        String   @default("UNKNOWN")
  ts            DateTime @default(now())
  createdAt     DateTime @default(now())

  @@unique([date, universeType, universeName, symbol])
}

model JobState {
  id           String   @id @default(uuid())
  universeType String // STOCK | CRYPTO
  universeName String
  status       String // PENDING, RUNNING, COMPLETED, FAILED
  cursorIndex  Int      @default(0)
  total        Int
  lastRunAt    DateTime @default(now())
  lastError    String?
  updatedAt    DateTime @updatedAt

  @@unique([universeType, universeName])
}

model AnalysisSnapshot {
  id          String   @id @default(uuid())
  date        String // YYYY-MM-DD
  assetType   String // STOCK | CRYPTO
  symbol      String
  role        String // TECHNICAL, FUNDAMENTAL, SENTIMENT, BULL, BEAR, RISK, CONSENSUS
  payloadJson String
  createdAt   DateTime @default(now())

  @@unique([date, assetType, symbol, role])
}

model UserPreferences {
  id        String   @id @default(uuid())
  userId    String   @unique
  mode      String   @default("BASIC") // ENUM(BASIC, ADVANCED)
  timezone  String   @default("America/Toronto")
  hideEmptyMarketOverview Boolean @default(false)
  hideEmptyCustomUniverses Boolean @default(false)
  hideEmptyPortfolio Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model AdminAuditLog {
  id           String   @id @default(uuid())
  actorUserId  String
  targetUserId String
  action       String
  metadataJson String
  createdAt    DateTime @default(now())

  actorUser  User @relation("actor", fields: [actorUserId], references: [id])
  targetUser User @relation("target", fields: [targetUserId], references: [id])
}

model AnalysisConfig {
  id             String   @id @default(uuid())
  userId         String
  name           String
  assetTypeScope String   @default("BOTH") // STOCK, CRYPTO, or BOTH
  configJson     String // Zod validated JSON containing technical weights and risk thresholds
  isActive       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model PromptTemplate {
  id           String   @id @default(uuid())
  userId       String
  scope        String   @default("GLOBAL") // GLOBAL or specific Universe ID
  role         String // TECHNICAL, RISK, CONSENSUS, etc.
  templateText String
  outputMode   String   @default("TEXT_ONLY") // TEXT_ONLY, or ACTION_LABELS
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, scope, role])
}

model Universe {
  id             String   @id @default(uuid())
  userId         String
  name           String
  universeType   String // STOCK | CRYPTO
  definitionJson String
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model DemoSnapshotMeta {
  id                 String   @id @default(uuid())
  snapshotAnchorDate String // YYYY-MM-DDTHH:00
  nextRefreshAfter   String // YYYY-MM-DDTHH:00
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model DemoAssetSnapshot {
  id                 String   @id @default(uuid())
  snapshotAnchorDate String
  assetType          String
  symbol             String
  quoteJson          String
  candlesJson        String
  indicatorsJson     String
  riskFlagsJson      String
  firmViewJson       String
  createdAt          DateTime @default(now())

  @@unique([snapshotAnchorDate, assetType, symbol])
}

model DemoScreenerSnapshot {
  id                 String   @id @default(uuid())
  snapshotAnchorDate String
  universeType       String
  universeName       String
  symbol             String
  assetType          String   @default("STOCK")
  score              Float
  metricsJson        String
  price              Float    @default(0)
  riskFlagsJson      String   @default("{}")
  createdAt          DateTime @default(now())

  @@unique([snapshotAnchorDate, universeType, universeName, symbol])
}

model PriceHistory {
  id        String   @id @default(uuid())
  symbol    String
  assetType String // STOCK | CRYPTO
  date      String // YYYY-MM-DD
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float
  createdAt DateTime @default(now())

  @@unique([assetType, symbol, date])
  @@index([assetType, symbol, date])
}

model SymbolCacheState {
  id            String    @id @default(uuid())
  assetType     String
  symbol        String
  status        String    @default("PENDING") // PENDING, READY, FAILED
  earliestDate  String?
  latestDate    String?
  barsCount     Int       @default(0)
  lastAttemptAt DateTime?
  lastSuccessAt DateTime?
  lastError     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([assetType, symbol])
  @@index([status])
}

model AlertRule {
  id              String   @id @default(uuid())
  userId          String
  symbol          String
  conditionType   String   // PRICE_ABOVE, PRICE_BELOW, RSI_ABOVE, RSI_BELOW
  thresholdValue  Float
  isActive        Boolean  @default(true)
  lastTriggeredAt DateTime?
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model PortfolioPosition {
  id          String   @id @default(uuid())
  userId      String
  symbol      String
  assetType   String   @default("STOCK")
  quantity    Float
  averageCost Float
  acquiredAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model AssetFundamental {
  symbol           String   @id
  peRatio          Float?
  eps              Float?
  marketCap        Float?
  fiftyTwoWeekHigh Float?
  fiftyTwoWeekLow  Float?
  targetPrice      Float?
  updatedAt        DateTime @default(now())
}

model EarningsEvent {
  id              String   @id @default(uuid())
  symbol          String
  date            String   // YYYY-MM-DD
  epsEstimate     Float?
  epsActual       Float?
  revenueEstimate Float?
  revenueActual   Float?

  @@unique([symbol, date])
}

model AssetNews {
  id             String   @id @default(uuid())
  symbol         String
  headline       String
  summary        String
  source         String
  url            String   @unique
  sentimentScore Float?   // -1.0 to 1.0
  publishedAt    DateTime
  createdAt      DateTime @default(now())
}

model InviteCode {
  id          String   @id @default(uuid())
  code        String   @unique
  maxUses     Int      @default(1)
  expiresAt   DateTime?
  createdBy   String   // User id of admin who created it
  createdAt   DateTime @default(now())
  
  uses        InviteCodeUse[]
}

model InviteCodeUse {
  id            String   @id @default(uuid())
  inviteCodeId  String
  userId        String   
  usedAt        DateTime @default(now())

  inviteCode    InviteCode @relation(fields: [inviteCodeId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([inviteCodeId, userId])
}
